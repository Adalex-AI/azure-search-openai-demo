After reviewing your codebase and the attached implementation plan, I can see that the agentic retrieval path bypasses your sophisticated legal citation enhancements. Here's a critical analysis and minimal edit instructions for Claude Sonnet 4:

## Critical Issues Found

1. **Agentic retrieval doesn't use your subsection splitting logic** - Documents like "Practice Direction 3E" with multiple subsections (1.1, 1.2, 2, 3, etc.) won't be split
2. **Missing three-part citation format** - Agent results bypass your `"subsection, sourcepage, sourcefile"` format
3. **No preview content for hover** - Agent path doesn't generate preview text for hover functionality
4. **Category filter incomplete** - Doesn't ensure "selected court OR CPR & Practice Directions" fallback

## Minimal Edit Instructions for Claude Sonnet 4

Here are the precise, minimal edits needed in `chatreadretrieveread.py` and `retrievethenread.py`:

### Edit 1: Add Agent Category Filter Method
**Location**: After the `build_filter` method in both files

````python
def _agent_category_filter(self, overrides: dict[str, Any]) -> Optional[str]:
    """Build category filter for agentic retrieval with CPR fallback."""
    include_category = overrides.get("include_category")
    if include_category and include_category != "All":
        return f"(category eq '{include_category}' or category eq 'Civil Procedure Rules and Practice Directions')"
    
    detected = overrides.get("detected_court_category")
    if detected:
        return f"(category eq '{detected}' or category eq 'Civil Procedure Rules and Practice Directions')"
    
    return "(category eq 'Civil Procedure Rules and Practice Directions' or category eq null)"
````

### Edit 2: Add Agent-to-Document Converter
**Location**: After the `_agent_category_filter` method

````python
def _agent_refs_to_documents(self, activities, references) -> list[Document]:
    """Convert agent references to Document objects with all fields."""
    by_activity = {}
    for a in activities or []:
        q = getattr(a, "query", None)
        if q and hasattr(q, "search"):
            by_activity[getattr(a, "id", None)] = q.search
    
    docs = []
    for ref in references or []:
        source_data = getattr(ref, "source_data", {}) or {}
        docs.append(
            Document(
                id=str(getattr(ref, "doc_key", source_data.get("id", ""))),
                content=str(source_data.get("content", "")),
                category=str(source_data.get("category", "")),
                sourcepage=str(source_data.get("sourcepage", "")),
                sourcefile=str(source_data.get("sourcefile", "")),
                storage_url=str(source_data.get("storageUrl", "")),
                search_agent_query=by_activity.get(getattr(ref, "activity_source", None), "")
            )
        )
    return docs
````

### Edit 3: Add Subsection Splitter
**Location**: After the `_agent_refs_to_documents` method

````python
def _explode_subsections(self, docs: list[Document]) -> list[Document]:
    """Apply subsection splitting to agent documents."""
    out = []
    for d in docs:
        splits = self._extract_multiple_subsections_from_document(d)
        if splits and len(splits) > 1:
            for i, s in enumerate(splits):
                out.append(
                    Document(
                        id=f"{d.id}#sub{i}",
                        content=s["content"],
                        category=d.category,
                        sourcepage=d.sourcepage,
                        sourcefile=d.sourcefile,
                        storage_url=d.storage_url,
                        search_agent_query=d.search_agent_query
                    )
                )
        else:
            out.append(d)
    return out
````

### Edit 4: Wire Into Agentic Method
**Location**: In `run_agentic_retrieval_approach` method, find where agent results are processed

**Find this pattern**:
```python
response, results = await self.run_agentic_retrieval(
    # ... parameters ...
)
```

**Replace the section after agent call with**:
````python
# After the agent retrieval call returns response, activities, references
filter_add_on = self._agent_category_filter(overrides)

# Convert agent references to Documents
agent_docs = self._agent_refs_to_documents(activities, references)

# Apply subsection splitting
agent_docs = self._explode_subsections(agent_docs)

# Use existing get_sources_content for three-part citations
text_sources = self.get_sources_content(
    agent_docs,
    use_semantic_captions=False,
    use_image_citation=False
)
````

## Why This Works for Your Examples

1. **Practice Direction 3E**: Content has "1.1", "1.2", "2", "3" → splits into 4+ sources with citations like "1.1, Costs Capping, Practice Direction 3E"

2. **Part 1 - Overriding Objective**: Content has "1.1", "1.2", "1.3", "1.4" → splits into sources with "1.1, Overriding Objective, Part 1"

3. **Circuit Commercial Court Guide A4**: Content has "A4.1", "A4.2", "A4.3" → creates "A4.1, A.4 Support For Litigants in Person (p. 7), Circuit Commercial Court Guide"

## Critical Implementation Notes

1. **No prompt changes needed** - Sources will have the same format as non-agent path
2. **Hover previews work** - `get_sources_content` already handles preview generation
3. **Category context preserved** - Filter ensures court-specific + CPR results
4. **Storage URLs intact** - Document conversion preserves all fields

## Testing the Changes

After implementing, test with:
```python
# Test query with category selection
overrides = {"include_category": "Circuit Commercial Court"}
query = "What support is available for litigants in person?"

# Should return:
# - A4.1, A4.2, A4.3 from Circuit Commercial Court Guide
# - Any relevant CPR rules about litigants in person
```

The beauty of this approach is that it reuses your existing sophisticated citation system - we're just ensuring the agent path feeds documents through the same pipeline as the regular search path.